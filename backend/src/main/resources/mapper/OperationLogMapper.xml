<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.kokoachino.mapper.OperationLogMapper">

    <!-- 查询团队的操作日志 -->
    <select id="selectByTeamId" resultType="com.github.kokoachino.model.entity.OperationLog">
        SELECT * FROM tw_operation_log
        WHERE team_id = #{teamId}
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 按条件查询日志 -->
    <select id="selectByConditions" resultType="com.github.kokoachino.model.entity.OperationLog">
        SELECT * FROM tw_operation_log
        WHERE team_id = #{teamId}
        <if test="eventType != null and eventType != ''">
            AND event_type = #{eventType}
        </if>
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        <if test="startTime != null">
            AND created_at &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_at &lt;= #{endTime}
        </if>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 统计日志数量 -->
    <select id="countByConditions" resultType="java.lang.Long">
        SELECT COUNT(*) FROM tw_operation_log
        WHERE team_id = #{teamId}
        <if test="eventType != null and eventType != ''">
            AND event_type = #{eventType}
        </if>
        <if test="userId != null">
            AND user_id = #{userId}
        </if>
        <if test="startTime != null">
            AND created_at &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_at &lt;= #{endTime}
        </if>
    </select>

    <!-- 根据邀请码ID查询加入团队记录 -->
    <select id="selectInviteRecordsByInviteCodeId" resultType="com.github.kokoachino.model.entity.OperationLog">
        SELECT * FROM tw_operation_log
        WHERE event_type = 'TEAM_JOIN'
          AND JSON_EXTRACT(details, '$.inviteCodeId') = #{inviteCodeId}
        ORDER BY created_at DESC
    </select>

</mapper>
